using RadonKA
using Test

@testset "RadonKA.jl" begin


    @testset "radon without absorption" begin

	    array = zeros((16, 16,1))
	    array[12,9] = 1
        angles = range(0, 2pi, 100)
        sg = radon(array, angles)
        begin
	        theory = zeros(size(sg))

	        i = 1
	        for θ in angles
	        	cc = size(sg, 1) ÷ 2 + 1
	        	x,y = (12, 9) .- (cc)

	        	x,y = [cos(θ) sin(θ); -sin(θ) cos(θ)] * [x, y]

	        	c =  cc + x - 1 + 1f-8

	        	c1 = floor(Int, c)
	        	c2 = ceil(Int, c)

	        	theory[c1, i] += (c2 - c)
	        	theory[c2, i] += (c - c1)
	        	i += 1
	        end
        end

        @test ≈(sg, theory, rtol=0.1)


        begin
        	array2 = zeros((16, 16,1))
        	array2[12,9] = 1
        	array2[12, 12] = 1
        end
        @test (radon(array2, [0, pi / 4, pi / 2, pi]))[:, :, 1] ≈ [0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.9999999999999991; 0.0 0.0 0.0 8.881784197001252e-16; 0.0 0.0 0.0 0.0; 0.0 0.0 0.5 0.0; 0.0 0.021096917038194177 0.0 0.0; 0.0 0.4547981021891796 0.0 0.0; 1.0 0.046501901770703645 0.5 0.0; 0.0 0.3888441697924858 0.0 0.0; 0.0 0.08280156180214897 0.0 0.0; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0]



    end




    @testset "iradon without absorption" begin
        sinogram = zeros((10, 2, 1))
	    sinogram[5, :, 1] .= 1
        
        @test iradon(sinogram, [0.0f0, pi / 2.0f0]) == [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.5 0.5 0.5 0.5 1.0 0.5 0.5 0.5 0.5; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0;;;]
        @test iradon(sinogram, [0]) == [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

    end

    @testset "iradon with absorption" begin
        sinogram = zeros((10, 2, 1))
	    sinogram[5, :, 1] .= 1
        
        @test iradon(sinogram, [0], 1) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.00033546262 0.000911882 0.0024787523 0.006737947 0.01831564 0.049787067 0.13533528 0.36787945 1.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

        @test iradon(sinogram, [pi], 1) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.36787945 0.13533528 0.049787067 0.01831564 0.006737947 0.0024787523 0.000911882 0.00033546262; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

        @test iradon(sinogram, [pi + pi / 2], 1) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.00033546262 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.000911882 9.196053f-19 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0024787523 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.006737947 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.01831564 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.049787067 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.13533528 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 3.7099527f-16 0.36787945 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0;;;]
    end

end
