using RadonKA
using Test

@testset "RadonKA.jl" begin


    @testset "radon without absorption" begin

	    array = zeros((16, 16,1))
	    array[12,9] = 1
        angles = range(0, 2pi, 100)
        sg = radon(array, angles)
        begin
	        theory = zeros(size(sg))

	        i = 1
	        for θ in angles
	        	cc = size(sg, 1) ÷ 2 + 1
	        	x,y = (12, 9) .- (cc)

	        	x,y = [cos(θ) sin(θ); -sin(θ) cos(θ)] * [x, y]

	        	c =  cc + x - 1 + 1f-8

	        	c1 = floor(Int, c)
	        	c2 = ceil(Int, c)

	        	theory[c1, i] += (c2 - c)
	        	theory[c2, i] += (c - c1)
	        	i += 1
	        end
        end

        @test ≈(sg, theory, rtol=0.1)


        begin
        	array2 = zeros((16, 16,1))
        	array2[12,9] = 1
        	array2[12, 12] = 1
        end


        @test radon(array, range(0, pi, 8), 1.0) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0013106791246981077 0.0059024956158884164; 0.0 0.0 0.0 0.0 0.0 0.00035964724781605066 0.00023070310021843104 0.0; 0.0 0.0 0.0 0.0 0.00010934973082693491 4.091501530026382e-5 0.0 0.0; 0.0 0.0 0.0 3.8440644349164666e-5 3.8440644349164666e-5 0.0 0.0 0.0; 0.0 0.0 4.0915015300263786e-5 0.00010934973082693491 0.0 0.0 0.0 0.0; 0.0 0.00023070310021842976 0.0003596472478160496 0.0 0.0 0.0 0.0 0.0; 0.0059024956158884164 0.001310679124698108 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

        @test radon(array, range(0, pi, 8), 1.0) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0013106791246981077 0.0059024956158884164; 0.0 0.0 0.0 0.0 0.0 0.00035964724781605066 0.00023070310021843104 0.0; 0.0 0.0 0.0 0.0 0.00010934973082693491 4.091501530026382e-5 0.0 0.0; 0.0 0.0 0.0 3.8440644349164666e-5 3.8440644349164666e-5 0.0 0.0 0.0; 0.0 0.0 4.0915015300263786e-5 0.00010934973082693491 0.0 0.0 0.0 0.0; 0.0 0.00023070310021842976 0.0003596472478160496 0.0 0.0 0.0 0.0 0.0; 0.0059024956158884164 0.001310679124698108 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

    end




    @testset "iradon without absorption" begin
        sinogram = zeros((10, 2, 1))
	    sinogram[5, :, 1] .= 1
        
        @test iradon(sinogram, [0.0f0, pi / 2.0f0]) == [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.5 0.5 0.5 0.5 1.0 0.5 0.5 0.5 0.5; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.5 0.0 0.0 0.0 0.0;;;]
        @test iradon(sinogram, [0]) == [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

    end

    @testset "iradon with absorption" begin
        sinogram = zeros((10, 2, 1))
	    sinogram[5, :, 1] .= 1
        
        @test iradon(sinogram, [0], 1.0) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.00033546262 0.000911882 0.0024787523 0.006737947 0.01831564 0.049787067 0.13533528 0.36787945 1.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

        @test iradon(sinogram, [pi], 1.0) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 1.0 0.36787945 0.13533528 0.049787067 0.01831564 0.006737947 0.0024787523 0.000911882 0.00033546262; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;;;]

        @test iradon(sinogram, [pi + pi / 2], 1.0) ≈ [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.00033546262 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.000911882 9.196053f-19 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0024787523 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.006737947 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.01831564 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.049787067 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.13533528 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 3.7099527f-16 0.36787945 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0;;;]
    end

end
